// ===================== Render Calendar =====================
let calDate = new Date();

function renderCalendar(){
  calendar.innerHTML = '';
  const y = calDate.getFullYear(), m = calDate.getMonth();
  const firstDay = new Date(y,m,1).getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();
  labelMonth.textContent = calDate.toLocaleString('default',{month:'long', year:'numeric'});

  // Empty cells for offset
  for(let i=0;i<firstDay;i++){ 
    const div = document.createElement('div'); 
    div.className='day'; 
    calendar.appendChild(div); 
  }

  for(let d=1; d<=daysInMonth; d++){
    const div = document.createElement('div'); 
    div.className='day';
    const dt = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    div.textContent = d;

    // Highlight if record exists
    if(attendanceHistory.some(h=>h.date===dt)) div.classList.add('has-record');

    div.addEventListener('click', ()=>{
      selDate.textContent = dt; 
      renderHistory(dt);
    });

    calendar.appendChild(div);
  }
}

// ===================== Render History =====================
function renderHistory(date){
  listHistory.innerHTML='';
  const record = attendanceHistory.find(h=>h.date===date);

  if(!record){ 
    listHistory.innerHTML='<li class="list-group-item">No record</li>'; 
    return; 
  }

  const presentList = members.filter(m=>record.presentPhones.includes(m.phone));
  const absentList = members.filter(m=>!record.presentPhones.includes(m.phone));

  // Only show absentees if session is closed
  const showAbsent = !currentSession.active || currentSession.date !== date;

  const listToShow = viewPresent.checked ? presentList : (showAbsent ? absentList : []);

  if(!listToShow.length){
    listHistory.innerHTML='<li class="list-group-item">None</li>'; 
    return;
  }

  listToShow.forEach(m=>{
    const li = document.createElement('li'); 
    li.className='list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${m.fullName} (${m.phone})</span>
                    <a class="btn btn-sm btn-outline-success" target="_blank" href="https://wa.me/${formatPhoneForWhatsApp(m.phone)}?text=${encodeURIComponent('We missed you at church!')}"><i class="bi bi-whatsapp"></i></a>`;
    listHistory.appendChild(li);
  });
}

// ===================== View Mode Toggle =====================
viewPresent.addEventListener('change', ()=>{
  if(selDate.textContent!=='—') renderHistory(selDate.textContent);
});

viewAbsent.addEventListener('change', ()=>{
  if(selDate.textContent!=='—') renderHistory(selDate.textContent);
});
