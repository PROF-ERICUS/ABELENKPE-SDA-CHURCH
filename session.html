<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance â€“ ABELENKPE SDA CHURCH</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { display:flex; flex-direction:column; min-height:100vh; margin:0; background:#f8f9fa;}
header { background-color:#f71717; color:white; padding:1rem; position:fixed; top:0; width:100%; z-index:1000; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
header h3 { margin:0;}
main { flex:1 0 auto; padding:120px 15px 20px; max-width:1100px; margin:auto;}
.card { margin-bottom:20px;}
footer { flex-shrink:0; background-color:#343a40; color:white; padding:1rem; text-align:center;}
.stat-card { border-radius:14px; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.15);}
.stat-all { background:linear-gradient(135deg,#ff416c,#ff4b2b);}
.stat-present { background:linear-gradient(135deg,#00c6ff,#0072ff);}
.stat-absent { background:linear-gradient(135deg,#8e2de2,#4a00e0);}
.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar .day { background:#fff; border-radius:8px; border:1px solid #e5e7eb; padding:8px; text-align:center; cursor:pointer; }
.calendar .day.has-record { background:linear-gradient(135deg,#f71717,#ff5252); color:#fff; font-weight:600; }
.calendar .day.selected { outline:3px solid #212529; }
</style>
</head>
<body>

<header class="d-flex align-items-center justify-content-between flex-wrap gap-2">
  <h3 class="mb-0">Attendance</h3>
  <nav class="d-flex gap-2 flex-wrap">
   <a href="index.html" class="btn btn-light btn-sm">Home</a>
    <a href="registration.html" class="btn btn-light btn-sm">Register</a>
    <a href="admin-dash.html" class="btn btn-light btn-sm">Admin</a>
    <a href="session.html" class="btn btn-light btn-sm">Attendance</a>
  </nav>
</header>

<main>
<h2 class="text-center mb-4">ðŸ“… Attendance Session</h2>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="p-3 stat-card stat-all text-center">
      <i class="bi bi-people-fill fs-1"></i>
      <div class="fw-semibold">Total Members</div>
      <div id="statTotal" class="display-6">0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 stat-card stat-present text-center">
      <i class="bi bi-person-check-fill fs-1"></i>
      <div class="fw-semibold">Present</div>
      <div id="statPresent" class="display-6">0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 stat-card stat-absent text-center">
      <i class="bi bi-person-x-fill fs-1"></i>
      <div class="fw-semibold">Absent</div>
      <div id="statAbsent" class="display-6">0</div>
    </div>
  </div>
</div>

<!-- Session Controls -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Session</h5>
      <div id="pillSession" class="badge bg-secondary">No Active Session</div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input id="inDate" type="date" class="form-control" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Time</label>
        <input id="inTime" type="time" class="form-control" />
      </div>
      <div class="col-md-4 d-grid d-md-flex align-items-end gap-2">
        <button id="btnStart" class="btn btn-primary flex-fill">Start</button>
        <button id="btnClose" class="btn btn-danger flex-fill">Close & Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Members List -->
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">Members</h5>
    <ul id="listMembers" class="list-group"></ul>
  </div>
</div>

<!-- Calendar & History -->
<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-3">Attendance History</h5>
    <div class="row">
      <div class="col-md-6">
        <div class="calendar p-2 border rounded bg-white" id="calendar"></div>
        <div class="mt-2 d-flex justify-content-between">
          <button id="prevMonth" class="btn btn-sm btn-light">â—€ Prev</button>
          <span id="labelMonth" class="fw-semibold"></span>
          <button id="nextMonth" class="btn btn-sm btn-light">Next â–¶</button>
        </div>
      </div>
      <div class="col-md-6">
        <h6>Selected Date: <span id="selDate">â€”</span></h6>
        <div class="d-flex gap-2 mb-2">
          <input type="radio" name="viewMode" id="viewPresent" checked> <label for="viewPresent">Present</label>
          <input type="radio" name="viewMode" id="viewAbsent"> <label for="viewAbsent">Absent</label>
        </div>
        <ul id="listHistory" class="list-group mb-2" style="max-height:300px; overflow:auto;"></ul>
        <button id="btnNotifySelDate" class="btn btn-warning">Notify Selected</button>
      </div>
    </div>
  </div>
</div>

<footer>&copy; <span id="year"></span> ABELENKPE SDA CHURCH</footer>

<script>
// ------------------ LocalStorage ------------------
const LS_KEYS = { members:'members', session:'currentSession', history:'attendanceHistory' };
let members = JSON.parse(localStorage.getItem(LS_KEYS.members)) || [
  {fullName:'John Doe', phone:'0244000000', role:'Class 1'},
  {fullName:'Jane Smith', phone:'0244111111', role:'Class 2'}
];
let currentSession = JSON.parse(localStorage.getItem(LS_KEYS.session)) || { active:false, date:null, time:null, presentPhones:[] };
let attendanceHistory = JSON.parse(localStorage.getItem(LS_KEYS.history)) || [];

// ------------------ Elements ------------------
const statTotal=document.getElementById('statTotal');
const statPresent=document.getElementById('statPresent');
const statAbsent=document.getElementById('statAbsent');
const pillSession=document.getElementById('pillSession');
const listMembers=document.getElementById('listMembers');
const inDate=document.getElementById('inDate');
const inTime=document.getElementById('inTime');
const btnStart=document.getElementById('btnStart');
const btnClose=document.getElementById('btnClose');
const calendar=document.getElementById('calendar');
const labelMonth=document.getElementById('labelMonth');
const prevMonth=document.getElementById('prevMonth');
const nextMonth=document.getElementById('nextMonth');
const selDate=document.getElementById('selDate');
const listHistory=document.getElementById('listHistory');
const viewPresent=document.getElementById('viewPresent');
const viewAbsent=document.getElementById('viewAbsent');
const btnNotifySelDate=document.getElementById('btnNotifySelDate');

// ------------------ Utils ------------------
const saveMembers=()=>localStorage.setItem(LS_KEYS.members,JSON.stringify(members));
const saveSession=()=>localStorage.setItem(LS_KEYS.session,JSON.stringify(currentSession));
const saveHistory=()=>localStorage.setItem(LS_KEYS.history,JSON.stringify(attendanceHistory));

function updateStats(){
  statTotal.textContent=members.length;
  statPresent.textContent=currentSession.presentPhones.length;
  statAbsent.textContent=Math.max(0,members.length-currentSession.presentPhones.length);
  pillSession.innerHTML=currentSession.active?`<span class='text-dark bg-warning badge'>Active: ${currentSession.date} ${currentSession.time}</span>`:'<span class="badge bg-secondary">No Active Session</span>';
}

function isPresent(phone){return currentSession.presentPhones.includes(phone);}

// ------------------ Render Members ------------------
function renderMembers(){
  listMembers.innerHTML='';
  if(!members.length){ listMembers.innerHTML='<li class="list-group-item">No members</li>'; return;}
  members.forEach(m=>{
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center';
    const present=isPresent(m.phone);
    li.innerHTML=`
      <span>${m.fullName} (${m.role}) - ${m.phone} <strong>${present?'Present':'Absent'}</strong></span>
      <input type="checkbox" class="select-member" data-phone="${m.phone}" ${!present?'checked':''}/>
      <button class="btn btn-sm btn-success mark-btn" data-phone="${m.phone}">${present?'Mark Absent':'Mark Present'}</button>
    `;
    listMembers.appendChild(li);
  });

  document.querySelectorAll('.mark-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const phone=btn.dataset.phone;
      if(currentSession.presentPhones.includes(phone)){
        currentSession.presentPhones=currentSession.presentPhones.filter(p=>p!==phone);
      }else currentSession.presentPhones.push(phone);
      saveSession(); updateStats(); renderMembers();
    });
  });
}

// ------------------ Render Calendar ------------------
let calDate=new Date();
function renderCalendar(){
  calendar.innerHTML='';
  const y=calDate.getFullYear(), m=calDate.getMonth();
  const firstDay=new Date(y,m,1).getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  labelMonth.textContent=calDate.toLocaleString('default',{month:'long',year:'numeric'});
  for(let i=0;i<firstDay;i++){calendar.appendChild(document.createElement('div'));}
  for(let d=1;d<=daysInMonth;d++){
    const div=document.createElement('div'); div.className='day';
    const dt=`${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    div.textContent=d;
    if(attendanceHistory.some(h=>h.date===dt)) div.classList.add('has-record');
    div.addEventListener('click',()=>{
      selDate.textContent=dt;
      document.querySelectorAll('.calendar .day').forEach(x=>x.classList.remove('selected'));
      div.classList.add('selected');
      renderHistory(dt);
    });
    calendar.appendChild(div);
  }
}

// ------------------ Render History ------------------
function renderHistory(date){
  listHistory.innerHTML='';
  const record=attendanceHistory.find(h=>h.date===date);
  if(!record){ listHistory.innerHTML='<li class="list-group-item">No record</li>'; return;}
  const list=viewPresent.checked? members.filter(m=>record.presentPhones.includes(m.phone)) : members.filter(m=>!record.presentPhones.includes(m.phone));
  if(!list.length){ listHistory.innerHTML='<li class="list-group-item">None</li>'; return;}
  list.forEach(m=>{
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between';
    li.innerHTML=`${m.fullName} (${m.phone}) <input type="checkbox" class="notify-member" data-phone="${m.phone}" checked/>`;
    listHistory.appendChild(li);
  });
}

// ------------------ Events ------------------
btnStart.addEventListener('click',()=>{
  if(currentSession.active){alert('Session already active!'); return;}
  if(!inDate.value || !inTime.value){alert('Select date & time'); return;}
  currentSession={active:true,date:inDate.value,time:inTime.value,presentPhones:[]};
  saveSession(); updateStats(); renderMembers();
});

btnClose.addEventListener('click',()=>{
  if(!currentSession.active){alert('No active session'); return;}
  attendanceHistory.push({...currentSession});
  currentSession.active=false; saveSession(); saveHistory(); updateStats(); renderMembers(); renderCalendar();
});

btnNotifySelDate.addEventListener('click',()=>{
  const checkboxes=document.querySelectorAll('.notify-member:checked');
  if(!checkboxes.length){alert('Select members to notify'); return;}
  checkboxes.forEach(cb=>{
    const phone=cb.dataset.phone;
    const msg=`Hello, we missed you at church!`;
    const waUrl=`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(waUrl,'_blank');
  });
});

// ------------------ Init ------------------
updateStats(); renderMembers(); renderCalendar();
document.getElementById('year').textContent=new Date().getFullYear();

prevMonth.addEventListener('click',()=>{calDate.setMonth(calDate.getMonth()-1); renderCalendar();});
nextMonth.addEventListener('click',()=>{calDate.setMonth(calDate.getMonth()+1); renderCalendar();});
viewPresent.addEventListener('change',()=>{ if(selDate.textContent!=='â€”') renderHistory(selDate.textContent);});
viewAbsent.addEventListener('change',()=>{ if(selDate.textContent!=='â€”') renderHistory(selDate.textContent);});

</script>
</body>
</html>
