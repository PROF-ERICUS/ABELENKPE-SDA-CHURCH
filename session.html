<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance â€“ ABELENKPE SDA CHURCH</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; background: #f8f9fa; }
header { background-color:#f71717; color: white; padding: 1rem; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: space-between; flex-wrap: wrap; align-items: center; transition: all 0.3s ease; }
header.shrink { padding: 0.5rem 1rem; }
header h3 { margin: 0; font-size: 1.5rem; transition: all 0.3s ease; }
header.shrink h3 { font-size: 1.2rem; }
nav a { margin: 0.3rem; }
main { flex: 1 0 auto; padding: 120px 15px 20px; max-width: 1100px; margin: auto; }
.card { margin-bottom: 20px; }
footer { flex-shrink: 0; background-color: #343a40; color: white; padding: 1rem; text-align: center; font-size: 0.9rem; }
#backToTop { position: fixed; bottom: 40px; right: 20px; display: none; z-index: 999; border-radius: 50%; width: 45px; height: 45px; font-size: 24px; line-height: 1; padding: 0; }
.stat-card { border-radius:14px; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.15); }
.stat-all { background:linear-gradient(135deg,#ff416c,#ff4b2b); }
.stat-present { background:linear-gradient(135deg,#00c6ff,#0072ff); }
.stat-absent { background:linear-gradient(135deg,#8e2de2,#4a00e0); }
.badge-role { font-size:.8rem; }
.present-pill { font-size:.8rem; }
.floating-tools { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:999; }
.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar .day { background:#fff; border-radius:8px; border:1px solid #e5e7eb; padding:8px; text-align:center; cursor:pointer; user-select:none; }
.calendar .day.muted { color:#adb5bd; }
.calendar .day.has-record { background:linear-gradient(135deg,#f71717,#ff5252); color:#fff; font-weight:600; }
.calendar .day.selected { outline:2px solid #212529; }
</style>
</head>
<body>
<header class="d-flex align-items-center justify-content-between flex-wrap gap-2">
  <h3 class="mb-0">Attendance</h3>
  <nav class="d-flex gap-2 flex-wrap">
    <a href="index.html" class="btn btn-light btn-sm">Home</a>
    <a href="registration.html" class="btn btn-light btn-sm">Register</a>
    <a href="admin-dash.html" class="btn btn-light btn-sm">Admin</a>
    <a href="session.html" class="btn btn-light btn-sm">Attendance</a>
  </nav>
</header>

<main>
  <h2 class="text-center mb-4">ðŸ“… Attendance Session</h2>

  <!-- Stats -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="p-3 stat-card stat-all text-center">
        <i class="bi bi-people-fill fs-1"></i>
        <div class="fw-semibold">Total Members</div>
        <div id="statTotal" class="display-6">0</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 stat-card stat-present text-center">
        <i class="bi bi-person-check-fill fs-1"></i>
        <div class="fw-semibold">Present</div>
        <div id="statPresent" class="display-6">0</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 stat-card stat-absent text-center">
        <i class="bi bi-person-x-fill fs-1"></i>
        <div class="fw-semibold">Absent</div>
        <div id="statAbsent" class="display-6">0</div>
      </div>
    </div>
  </div>

  <!-- Session Controls -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0">Session</h5>
        <div id="pillSession" class="badge bg-secondary">No Active Session</div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <label class="form-label">Date</label>
          <input id="inDate" type="date" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Time</label>
          <input id="inTime" type="time" class="form-control" />
        </div>
        <div class="col-md-4 d-grid d-md-flex align-items-end gap-2">
          <button id="btnStart" class="btn btn-primary flex-fill">Start</button>
          <button id="btnClose" class="btn btn-danger flex-fill">Close & Save</button>
        </div>
      </div>
      <div id="msg" class="mt-2"></div>
    </div>
  </div>

  <!-- Quick Mark -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Quick Mark by Phone</h5>
      <div class="input-group">
        <input id="inPhone" class="form-control" placeholder="Enter member phone" />
        <button id="btnMark" class="btn btn-success"><i class="bi bi-check2-square"></i> Mark</button>
      </div>
      <small class="text-muted">Tip: you can also click the green buttons in the list below.</small>
    </div>
  </div>

  <!-- Members List -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h5 class="mb-0">Members</h5>
        <div class="d-flex gap-2">
          <input id="search" type="search" class="form-control" placeholder="Search name, phone, role..." />
          <select id="roleFilter" class="form-select">
            <option value="">All Roles</option>
            <option>Class 1</option><option>Class 2</option><option>Class 3</option>
            <option>Class 4</option><option>Class 5</option><option>Class 6</option>
            <option>Class 7</option><option>Class 8</option><option>Class 9</option>
            <option>Class 10</option><option>Class 11</option><option>Class 12</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <ul id="listMembers" class="list-group"></ul>
    </div>
  </div>

  <!-- Calendar & History -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0">Attendance History</h5>
        <div class="d-flex gap-2">
          <button id="btnExportToday" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export Today</button>
          <button id="btnExportAbsentees" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export Absentees</button>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <div class="calendar p-2 border rounded bg-white" id="calendar"></div>
          <div class="mt-2 d-flex justify-content-between">
            <button id="prevMonth" class="btn btn-sm btn-light">â—€ Prev</button>
            <span id="labelMonth" class="fw-semibold"></span>
            <button id="nextMonth" class="btn btn-sm btn-light">Next â–¶</button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">Selected Date: <span id="selDate">â€”</span></div>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="viewMode" id="viewPresent" autocomplete="off" checked>
              <label class="btn btn-outline-success" for="viewPresent">Present</label>
              <input type="radio" class="btn-check" name="viewMode" id="viewAbsent" autocomplete="off">
              <label class="btn btn-outline-danger" for="viewAbsent">Absent</label>
            </div>
          </div>
          <ul id="listHistory" class="list-group" style="max-height:300px; overflow:auto;"></ul>

          <div class="mt-2 d-flex gap-2">
            <select id="printHistoryFilter" class="form-select form-select-sm">
              <option value="all">All Members</option>
              <option value="present">Present</option>
              <option value="absent">Absent</option>
            </select>
            <button id="btnPrintHistory" class="btn btn-secondary"><i class="bi bi-printer"></i> Print</button>
          </div>

          <div class="d-grid gap-2 mt-2">
            <button id="btnNotifySelDate" class="btn btn-warning"><i class="bi bi-megaphone"></i> Notify Absentees for Selected Date</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</main>

<footer>
  &copy; <span id="year"></span> ABELENKPE SDA CHURCH. All Rights Reserved.
</footer>

<!-- Floating tools -->
<div class="floating-tools">
  <button id="btnNotifyToday" class="btn btn-warning"><i class="bi bi-megaphone"></i> Notify Today</button>
  <button id="btnPrint" class="btn btn-secondary"><i class="bi bi-printer"></i> Print</button>
  <button id="btnClearToday" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Clear Today</button>
</div>
<button id="backToTop" class="btn btn-primary"><i class="bi bi-arrow-up"></i></button>

<!-- Toasts -->
<div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 1100">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div id="toastMsg" class="toast-body">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===================== Local Storage Keys =====================
const LS_KEYS = { members: 'members', session: 'currentSession', history: 'attendanceHistory' };

// ===================== State =====================
let members = JSON.parse(localStorage.getItem(LS_KEYS.members)) || [];
let currentSession = JSON.parse(localStorage.getItem(LS_KEYS.session)) || { active:false, date:null, time:null, presentPhones:[] };
let attendanceHistory = JSON.parse(localStorage.getItem(LS_KEYS.history)) || [];

// ===================== Elements =====================
const statTotal = document.getElementById('statTotal');
const statPresent = document.getElementById('statPresent');
const statAbsent = document.getElementById('statAbsent');
const pillSession = document.getElementById('pillSession');
const msg = document.getElementById('msg');

const inDate = document.getElementById('inDate');
const inTime = document.getElementById('inTime');
const inPhone = document.getElementById('inPhone');
const btnStart = document.getElementById('btnStart');
const btnClose = document.getElementById('btnClose');
const btnMark = document.getElementById('btnMark');

const search = document.getElementById('search');
const roleFilter = document.getElementById('roleFilter');
const listMembers = document.getElementById('listMembers');

const calendar = document.getElementById('calendar');
const labelMonth = document.getElementById('labelMonth');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const selDate = document.getElementById('selDate');
const listHistory = document.getElementById('listHistory');
const viewPresent = document.getElementById('viewPresent');
const viewAbsent = document.getElementById('viewAbsent');

const btnNotifyToday = document.getElementById('btnNotifyToday');
const btnNotifySelDate = document.getElementById('btnNotifySelDate');
const btnExportToday = document.getElementById('btnExportToday');
const btnExportAbsentees = document.getElementById('btnExportAbsentees');
const btnPrint = document.getElementById('btnPrint');
const btnClearToday = document.getElementById('btnClearToday');
const btnBack = document.getElementById('backToTop');

const printHistoryFilter = document.getElementById('printHistoryFilter');
const btnPrintHistory = document.getElementById('btnPrintHistory');

const toastEl = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const toast = new bootstrap.Toast(toastEl, { delay: 2500 });

// ===================== Utils =====================
const saveMembers = () => localStorage.setItem(LS_KEYS.members, JSON.stringify(members));
const saveSession = () => localStorage.setItem(LS_KEYS.session, JSON.stringify(currentSession));
const saveHistory = () => localStorage.setItem(LS_KEYS.history, JSON.stringify(attendanceHistory));

function showToast(message) { toastMsg.textContent = message; toast.show(); }

function updateStats() {
  statTotal.textContent = members.length;
  statPresent.textContent = currentSession.presentPhones.length;
  statAbsent.textContent = members.length - currentSession.presentPhones.length;
}

function renderSession() {
  if(currentSession.active) {
    pillSession.textContent = `Active (${currentSession.date || 'â€”'})`;
    inDate.value = currentSession.date || '';
    inTime.value = currentSession.time || '';
  } else pillSession.textContent = 'No Active Session';
}

// ===================== Members List =====================
function renderMembers() {
  const filterText = search.value.toLowerCase();
  const roleVal = roleFilter.value;
  listMembers.innerHTML = '';
  members.forEach(m => {
    if((m.fullName.toLowerCase().includes(filterText) || m.phone.includes(filterText) || m.role.includes(filterText))
       && (!roleVal || m.role === roleVal)) {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <div>
          <strong>${m.fullName}</strong> <span class="badge bg-secondary badge-role">${m.role}</span>
          <div class="text-muted small">${m.phone} | ${m.gender || 'â€”'}</div>
        </div>
        <button class="btn btn-sm ${currentSession.presentPhones.includes(m.phone)?'btn-success':'btn-outline-success'}">${currentSession.presentPhones.includes(m.phone)?'Present':'Mark'}</button>
      `;
      const btn = li.querySelector('button');
      btn.addEventListener('click', () => markPresent(m.phone));
      listMembers.appendChild(li);
    }
  });
}
// ===================== Calendar =====================
let viewYear, viewMonth; // month: 0-11
function initCalendarToToday(){
  const d = new Date();
  viewYear = d.getFullYear();
  viewMonth = d.getMonth();
}

function renderCalendar(){
  calendar.innerHTML = '';
  const first = new Date(viewYear, viewMonth, 1);
  const last = new Date(viewYear, viewMonth + 1, 0);
  const monthLabel = first.toLocaleDateString(undefined, { month:'long', year:'numeric' });
  labelMonth.textContent = monthLabel;

  // Weekday offset (0=Sun..6=Sat)
  const startOffset = first.getDay();
  const totalCells = startOffset + last.getDate();
  const todayIso = new Date().toISOString().slice(0,10);

  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('div');
    cell.className = 'day';
    if(i < startOffset){
      cell.classList.add('muted');
      cell.textContent = '';
    } else {
      const day = i - startOffset + 1;
      const iso = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      cell.textContent = day;
      const has = attendanceHistory.some(h=>h.date===iso);
      if(has) cell.classList.add('has-record');
      if(iso === selDate.textContent) cell.classList.add('selected');

      cell.addEventListener('click', ()=>{
        calendar.querySelectorAll('.day').forEach(d=>d.classList.remove('selected'));
        cell.classList.add('selected');
        selDate.textContent = iso;
        renderHistory(iso);
      });
    }
    calendar.appendChild(cell);
  }
}

prevMonth.addEventListener('click', ()=>{
  viewMonth--;
  if(viewMonth < 0){ viewMonth = 11; viewYear--; }
  renderCalendar();
});
nextMonth.addEventListener('click', ()=>{
  viewMonth++;
  if(viewMonth > 11){ viewMonth = 0; viewYear++; }
  renderCalendar();
});
  

// ===================== Mark Present =====================
function markPresent(phone) {
  if(!currentSession.active) { showToast('No active session!'); return; }
  if(!currentSession.presentPhones.includes(phone)) currentSession.presentPhones.push(phone);
  saveSession(); updateStats(); renderMembers();
}

// ===================== Start/Close Session =====================
btnStart.addEventListener('click', () => {
  if(!inDate.value || !inTime.value) { showToast('Select date and time'); return; }
  currentSession = { active:true, date:inDate.value, time:inTime.value, presentPhones:[] };
  saveSession(); renderSession(); updateStats(); renderMembers(); showToast('Session started');
});

btnClose.addEventListener('click', () => {
  if(!currentSession.active) { showToast('No active session'); return; }
  // Save session to history
  attendanceHistory.push({ date: currentSession.date, time: currentSession.time, presentPhones: [...currentSession.presentPhones] });
  saveHistory();
  currentSession = { active:false, date:null, time:null, presentPhones:[] };
  saveSession(); renderSession(); updateStats(); renderMembers(); showToast('Session closed and saved');
});

// ===================== Quick Mark =====================
btnMark.addEventListener('click', () => {
  const phone = inPhone.value.trim();
  if(!phone) return;
  markPresent(phone); inPhone.value = ''; showToast('Marked present');
});

// ===================== Print Today =====================
btnPrint.addEventListener('click', () => {
  const date = inDate.value || 'â€”';
  const presentSet = new Set(currentSession.presentPhones);

  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write(`
    <html>
    <head>
      <title>Attendance â€“ ${date}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header img { height: 80px; margin-bottom: 10px; }
        .header h2 { margin: 0; }
        .header p { margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 14px; }
        th { background: #f2f2f2; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; font-style: italic; }
        .signatures { margin-top: 50px; }
        .sign-line { margin-top: 40px; display: flex; justify-content: space-between; }
        .sign-box { width: 40%; text-align: center; }
        .sign-box hr { border: 0; border-top: 1px solid #000; margin: 40px 0 5px; }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="images/sda logo.png" alt="Logo">
        <h2>Abelenkpe SDA Church â€“ Official Attendance Sheet</h2>
        <p>Date: ${date} | Filter: Today</p>
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Gender</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${members.map(m => `
            <tr>
              <td>${m.fullName}</td>
              <td>${m.phone}</td>
              <td>${m.role}</td>
              <td>${m.gender || 'â€”'}</td>
              <td>${presentSet.has(m.phone) ? 'Present' : 'Absent'}</td>
            </tr>`).join('')}
        </tbody>
      </table>

      <div class="signatures">
        <div class="sign-line">
          <div class="sign-box">
            <hr>
            <p>Prepared By</p>
          </div>
          <div class="sign-box">
            <hr>
            <p>Approved By</p>
          </div>
        </div>
      </div>

      <div class="footer">
        Generated by Abelenkpe SDA Attendance System
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
});

// ===================== Init =====================
renderSession(); updateStats(); renderMembers();
document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>

