<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attendance – ABELENKPE SDA CHURCH</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<style>
body { display:flex; flex-direction:column; min-height:100vh; margin:0; background:#f8f9fa; }
header { background-color:#f71717; color:white; padding:1rem; position:fixed; top:0; width:100%; z-index:1000; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
main { flex:1 0 auto; padding:120px 15px 20px; max-width:1100px; margin:auto; }
.card { margin-bottom:20px; }
footer { flex-shrink:0; background-color:#343a40; color:white; padding:1rem; text-align:center; font-size:0.9rem; }
.stat-card { border-radius:14px; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.15); text-align:center; }
.stat-all { background:linear-gradient(135deg,#ff416c,#ff4b2b); }
.stat-present { background:linear-gradient(135deg,#00c6ff,#0072ff); }
.stat-absent { background:linear-gradient(135deg,#8e2de2,#4a00e0); }
.present-pill { font-size:.8rem; }
.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar .day { background:#fff; border-radius:8px; border:1px solid #e5e7eb; padding:8px; text-align:center; cursor:pointer; }
.calendar .day.has-record { background:linear-gradient(135deg,#f71717,#ff5252); color:#fff; font-weight:600; }
.calendar .day.selected { outline:2px solid #212529; }
</style>
</head>
<body>

<header class="d-flex align-items-center justify-content-between flex-wrap gap-2">
  <h3 class="mb-0">Attendance</h3>
  <nav class="d-flex gap-2 flex-wrap">
    <a href="index.html" class="btn btn-light btn-sm">Home</a>
    <a href="registration.html" class="btn btn-light btn-sm">Register</a>
    <a href="admin-dash.html" class="btn btn-light btn-sm">Admin</a>
    <a href="session.html" class="btn btn-light btn-sm">Attendance</a>
  </nav>
</header>

<main>
  <!-- Stats -->
  <div class="row g-3 mb-3">
    <div class="col-md-4"><div class="p-3 stat-card stat-all"><i class="bi bi-people-fill fs-1"></i><div>Total Members</div><div id="statTotal" class="display-6">0</div></div></div>
    <div class="col-md-4"><div class="p-3 stat-card stat-present"><i class="bi bi-person-check-fill fs-1"></i><div>Present</div><div id="statPresent" class="display-6">0</div></div></div>
    <div class="col-md-4"><div class="p-3 stat-card stat-absent"><i class="bi bi-person-x-fill fs-1"></i><div>Absent</div><div id="statAbsent" class="display-6">0</div></div></div>
  </div>

  <!-- Session Controls -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 mb-2">
        <div class="col-md-4"><input id="inDate" type="date" class="form-control" /></div>
        <div class="col-md-4"><input id="inTime" type="time" class="form-control" /></div>
        <div class="col-md-4 d-grid gap-2">
          <button id="btnStart" class="btn btn-primary">Start</button>
          <button id="btnClose" class="btn btn-danger">Close & Save</button>
        </div>
      </div>
      <div id="pillSession" class="badge bg-secondary">No Active Session</div>
    </div>
  </div>

  <!-- Members List -->
  <div class="card mb-3">
    <div class="card-body">
      <h5>Members</h5>
      <ul id="listMembers" class="list-group"></ul>
    </div>
  </div>

  <!-- Calendar & History -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Attendance History</h5>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <div class="calendar p-2 border rounded bg-white" id="calendar"></div>
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2 mb-2">
            <input type="radio" name="viewMode" id="viewPresent" checked> <label for="viewPresent">Present</label>
            <input type="radio" name="viewMode" id="viewAbsent"> <label for="viewAbsent">Absent</label>
          </div>
          <ul id="listHistory" class="list-group" style="max-height:300px; overflow:auto;"></ul>
          <button id="btnNotifySelDate" class="btn btn-warning mt-2" disabled>Notify Selected Absentees</button>
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  &copy; <span id="year"></span> ABELENKPE SDA CHURCH.
</footer>

<script>
const LS_KEYS={members:'members',session:'currentSession',history:'attendanceHistory'};
let members=JSON.parse(localStorage.getItem(LS_KEYS.members))||[];
let currentSession=JSON.parse(localStorage.getItem(LS_KEYS.session))||{active:false,date:null,time:null,presentPhones:[]};
let attendanceHistory=JSON.parse(localStorage.getItem(LS_KEYS.history))||[];

const statTotal=document.getElementById('statTotal');
const statPresent=document.getElementById('statPresent');
const statAbsent=document.getElementById('statAbsent');
const pillSession=document.getElementById('pillSession');
const inDate=document.getElementById('inDate');
const inTime=document.getElementById('inTime');
const btnStart=document.getElementById('btnStart');
const btnClose=document.getElementById('btnClose');
const listMembers=document.getElementById('listMembers');
const calendar=document.getElementById('calendar');
const selDate=document.getElementById('selDate');
const listHistory=document.getElementById('listHistory');
const viewPresent=document.getElementById('viewPresent');
const viewAbsent=document.getElementById('viewAbsent');
const btnNotifySelDate=document.getElementById('btnNotifySelDate');

const saveSession=()=>localStorage.setItem(LS_KEYS.session,JSON.stringify(currentSession));
const saveHistory=()=>localStorage.setItem(LS_KEYS.history,JSON.stringify(attendanceHistory));

function updateStats(){
  statTotal.textContent=members.length;
  statPresent.textContent=currentSession.active?currentSession.presentPhones.length:0;
  statAbsent.textContent=currentSession.active?members.length-currentSession.presentPhones.length:0;
  pillSession.innerHTML=currentSession.active?`<span class='badge bg-warning'>Active: ${currentSession.date}</span>`:'<span class="badge bg-secondary">No Active Session</span>';
}

function renderMembers(){
  listMembers.innerHTML='';
  members.forEach(m=>{
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center';
    const present=currentSession.active && currentSession.presentPhones.includes(m.phone);
    li.innerHTML=`<span>${m.fullName} (${m.phone}) <span class="badge ${present?'bg-success':'bg-secondary'}">${present?'Present':'Absent'}</span></span>
      <div><button class="btn btn-sm ${present?'btn-outline-success':'btn-success'} btn-toggle" data-phone="${m.phone}">${present?'Mark Absent':'Mark Present'}</button></div>`;
    listMembers.appendChild(li);
  });
}

let calDate=new Date();
function renderCalendar(){
  calendar.innerHTML='';
  const y=calDate.getFullYear(), m=calDate.getMonth();
  const firstDay=new Date(y,m,1).getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  for(let i=0;i<firstDay;i++){ const div=document.createElement('div'); div.className='day'; calendar.appendChild(div);}
  for(let d=1;d<=daysInMonth;d++){
    const div=document.createElement('div'); div.className='day';
    const dt=`${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    div.textContent=d;
    if(attendanceHistory.some(h=>h.date===dt)) div.classList.add('has-record');
    div.addEventListener('click',()=>{ selDate.textContent=dt; renderHistory(dt); });
    calendar.appendChild(div);
  }
}

function renderHistory(date){
  listHistory.innerHTML='';
  const record=attendanceHistory.find(h=>h.date===date);
  if(!record){ listHistory.innerHTML='<li class="list-group-item">No record</li>'; btnNotifySelDate.disabled=true; return; }
  const showPresent=viewPresent.checked;
  const list=showPresent?members.filter(m=>record.presentPhones.includes(m.phone)):members.filter(m=>!record.presentPhones.includes(m.phone));
  list.forEach(m=>{
    const li=document.createElement('li');
    li.className='list-group-item d-flex align-items-center';
    li.innerHTML=(!showPresent && !record.active)?`<input type="checkbox" class="history-checkbox me-2" data-phone="${m.phone}"> `:'';
    li.innerHTML+=`${m.fullName} (${m.phone}) <span class="badge ${showPresent?'bg-success':'bg-danger'}">${showPresent?'Present':'Absent'}</span>`;
    listHistory.appendChild(li);
  });
  btnNotifySelDate.disabled=showPresent || record.active || list.length===0;
}

// ===================== Events =====================
btnStart.addEventListener('click',()=>{
  if(!inDate.value||!inTime.value){ alert('Select date & time'); return;}
  currentSession={active:true,date:inDate.value,time:inTime.value,presentPhones:[]};
  saveSession(); updateStats(); renderMembers();
});

btnClose.addEventListener('click',()=>{
  if(!currentSession.active){ alert('No active session'); return;}
  // Mark absentees automatically
  const allPhones=members.map(m=>m.phone);
  const present=currentSession.presentPhones;
  currentSession.active=false;
  attendanceHistory.push({...currentSession,presentPhones:present});
  saveSession(); saveHistory(); updateStats(); renderMembers(); renderCalendar();
});

listMembers.addEventListener('click',e=>{
  const btn=e.target.closest('.btn-toggle'); if(!btn) return;
  const phone=btn.dataset.phone;
  if(currentSession.presentPhones.includes(phone)) currentSession.presentPhones=currentSession.presentPhones.filter(p=>p!==phone);
  else currentSession.presentPhones.push(phone);
  saveSession(); updateStats(); renderMembers();
});

btnNotifySelDate.addEventListener('click',()=>{
  const checkedBoxes=document.querySelectorAll('.history-checkbox:checked');
  if(!checkedBoxes.length){ alert('No members selected'); return;}
  const selectedMembers=Array.from(checkedBoxes).map(cb=>members.find(m=>m.phone===cb.dataset.phone));
  selectedMembers.forEach((m,i)=>{
    setTimeout(()=>{
      const msg=`Hello ${m.fullName}, we missed you at church on ${selDate.textContent}!`;
      const waUrl=`https://wa.me/${m.phone}?text=${encodeURIComponent(msg)}`;
      window.open(waUrl,'_blank');
    }, i*500);
  });
  alert(`Sent messages to ${selectedMembers.length} member(s)`);
});

viewPresent.addEventListener('change',()=>{ if(selDate.textContent!=='—') renderHistory(selDate.textContent); });
viewAbsent.addEventListener('change',()=>{ if(selDate.textContent!=='—') renderHistory(selDate.textContent); });

nowDefaults(); updateStats(); renderMembers(); renderCalendar();
document.getElementById('year').textContent=new Date().getFullYear();
</script>

</body>
</html>
