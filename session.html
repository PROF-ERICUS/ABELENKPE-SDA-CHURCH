<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance â€“ ABELENKPE SDA CHURCH</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { display:flex; flex-direction:column; min-height:100vh; margin:0; background:#f8f9fa;}
header { background-color:#f71717; color:white; padding:1rem; position:fixed; top:0; width:100%; z-index:1000; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; transition:all 0.3s ease; }
header h3 { margin:0; font-size:1.5rem; transition:all 0.3s ease; }
main { flex:1 0 auto; padding:120px 15px 20px; max-width:1100px; margin:auto; }
.card { margin-bottom:20px; }
footer { flex-shrink:0; background-color:#343a40; color:white; padding:1rem; text-align:center; font-size:0.9rem; }
.stat-card { border-radius:14px; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.15); }
.stat-all { background:linear-gradient(135deg,#ff416c,#ff4b2b); }
.stat-present { background:linear-gradient(135deg,#00c6ff,#0072ff); }
.stat-absent { background:linear-gradient(135deg,#8e2de2,#4a00e0); }
.badge-role { font-size:.8rem; }
.present-pill { font-size:.8rem; }
.floating-tools { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:999; }
.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar .day { background:#fff; border-radius:8px; border:1px solid #e5e7eb; padding:8px; text-align:center; cursor:pointer; }
.calendar .day.has-record { background:linear-gradient(135deg,#f71717,#ff5252); color:#fff; font-weight:600; }
.calendar .day.selected { outline:2px solid #212529; }
</style>
</head>
<body>
<header class="d-flex align-items-center justify-content-between flex-wrap gap-2">
  <h3 class="mb-0">Attendance</h3>
  <nav class="d-flex gap-2 flex-wrap">
    <a href="index.html" class="btn btn-light btn-sm">Home</a>
    <a href="registration.html" class="btn btn-light btn-sm">Register</a>
    <a href="admin-dash.html" class="btn btn-light btn-sm">Admin</a>
    <a href="session.html" class="btn btn-light btn-sm">Attendance</a>
  </nav>
</header>

<main>
<h2 class="text-center mb-4">ðŸ“… Attendance Session</h2>

<!-- Stats -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="p-3 stat-card stat-all text-center">
      <i class="bi bi-people-fill fs-1"></i>
      <div class="fw-semibold">Total Members</div>
      <div id="statTotal" class="display-6">0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 stat-card stat-present text-center">
      <i class="bi bi-person-check-fill fs-1"></i>
      <div class="fw-semibold">Present</div>
      <div id="statPresent" class="display-6">0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="p-3 stat-card stat-absent text-center">
      <i class="bi bi-person-x-fill fs-1"></i>
      <div class="fw-semibold">Absent</div>
      <div id="statAbsent" class="display-6">0</div>
    </div>
  </div>
</div>

<!-- Session Controls -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Session</h5>
      <div id="pillSession" class="badge bg-secondary">No Active Session</div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input id="inDate" type="date" class="form-control"/>
      </div>
      <div class="col-md-4">
        <label class="form-label">Time</label>
        <input id="inTime" type="time" class="form-control"/>
      </div>
      <div class="col-md-4 d-grid d-md-flex align-items-end gap-2">
        <button id="btnStart" class="btn btn-primary flex-fill">Start</button>
        <button id="btnClose" class="btn btn-danger flex-fill">Close & Save</button>
      </div>
    </div>
    <div id="msg" class="mt-2"></div>
  </div>
</div>

<!-- Quick Mark -->
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">Quick Mark by Phone</h5>
    <div class="input-group">
      <input id="inPhone" class="form-control" placeholder="Enter member phone"/>
      <button id="btnMark" class="btn btn-success"><i class="bi bi-check2-square"></i> Mark</button>
    </div>
    <small class="text-muted">Tip: you can also click the green buttons in the list below.</small>
  </div>
</div>

<!-- Members List -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <h5 class="mb-0">Members</h5>
      <div class="d-flex gap-2">
        <input id="search" type="search" class="form-control" placeholder="Search name, phone, role..."/>
        <select id="roleFilter" class="form-select">
          <option value="">All Roles</option>
          <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
          <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
          <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
          <option>Other</option>
        </select>
      </div>
    </div>
    <ul id="listMembers" class="list-group"></ul>
  </div>
</div>

<!-- Calendar & History -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Attendance History</h5>
      <div class="d-flex gap-2">
        <button id="btnExportToday" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export Today</button>
        <button id="btnExportAbsentees" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export Absentees</button>
      </div>
    </div>
    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <div class="calendar p-2 border rounded bg-white" id="calendar"></div>
        <div class="mt-2 d-flex justify-content-between">
          <button id="prevMonth" class="btn btn-sm btn-light">â—€ Prev</button>
          <span id="labelMonth" class="fw-semibold"></span>
          <button id="nextMonth" class="btn btn-sm btn-light">Next â–¶</button>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="fw-semibold">Selected Date: <span id="selDate">â€”</span></div>
          <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="viewPresent" autocomplete="off" checked>
            <label class="btn btn-outline-success" for="viewPresent">Present</label>
            <input type="radio" class="btn-check" name="viewMode" id="viewAbsent" autocomplete="off">
            <label class="btn btn-outline-danger" for="viewAbsent">Absent</label>
          </div>
        </div>
        <ul id="listHistory" class="list-group" style="max-height:300px; overflow:auto;"></ul>
        <div class="d-grid gap-2 mt-2">
          <button id="btnNotifySelDate" class="btn btn-warning"><i class="bi bi-megaphone"></i> Notify Selected</button>
        </div>
      </div>
    </div>
  </div>
</div>
</main>

<footer>
  &copy; <span id="year"></span> ABELENKPE SDA CHURCH. All Rights Reserved.
</footer>

<!-- Floating tools -->
<div class="floating-tools">
  <button id="btnNotifyToday" class="btn btn-warning"><i class="bi bi-megaphone"></i> Notify Today</button>
  <button id="btnPrint" class="btn btn-secondary"><i class="bi bi-printer"></i> Print</button>
  <button id="btnClearToday" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Clear Today</button>
</div>

<button id="backToTop" class="btn btn-primary"><i class="bi bi-arrow-up"></i></button>

<!-- Toast -->
<div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index:1100">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div id="toastMsg" class="toast-body">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ======= Local Storage =======
const LS_KEYS={members:'members',session:'currentSession',history:'attendanceHistory'};
let members=JSON.parse(localStorage.getItem(LS_KEYS.members))||[];
let currentSession=JSON.parse(localStorage.getItem(LS_KEYS.session))||{active:false,date:null,time:null,presentPhones:[]};
let attendanceHistory=JSON.parse(localStorage.getItem(LS_KEYS.history))||[];

// ======= Elements =======
const statTotal=document.getElementById('statTotal');
const statPresent=document.getElementById('statPresent');
const statAbsent=document.getElementById('statAbsent');
const pillSession=document.getElementById('pillSession');
const inDate=document.getElementById('inDate');
const inTime=document.getElementById('inTime');
const inPhone=document.getElementById('inPhone');
const btnStart=document.getElementById('btnStart');
const btnClose=document.getElementById('btnClose');
const btnMark=document.getElementById('btnMark');
const search=document.getElementById('search');
const roleFilter=document.getElementById('roleFilter');
const listMembers=document.getElementById('listMembers');
const calendar=document.getElementById('calendar');
const labelMonth=document.getElementById('labelMonth');
const prevMonth=document.getElementById('prevMonth');
const nextMonth=document.getElementById('nextMonth');
const selDate=document.getElementById('selDate');
const listHistory=document.getElementById('listHistory');
const viewPresent=document.getElementById('viewPresent');
const viewAbsent=document.getElementById('viewAbsent');
const btnNotifySelDate=document.getElementById('btnNotifySelDate');
const btnNotifyToday=document.getElementById('btnNotifyToday');
const toastEl=document.getElementById('toast');
const toastMsg=document.getElementById('toastMsg');
const toast=new bootstrap.Toast(toastEl,{delay:2500});

// ======= Utils =======
const saveMembers=()=>localStorage.setItem(LS_KEYS.members,JSON.stringify(members));
const saveSession=()=>localStorage.setItem(LS_KEYS.session,JSON.stringify(currentSession));
const saveHistory=()=>localStorage.setItem(LS_KEYS.history,JSON.stringify(attendanceHistory));
function nowDefaults(){ const d=new Date(); inDate.value=d.toISOString().slice(0,10); inTime.value=d.toTimeString().slice(0,5); }
function showToast(text){ toastMsg.textContent=text; toast.show(); }
function updateStats(){
  statTotal.textContent=members.length;
  statPresent.textContent=currentSession.presentPhones.length;
  statAbsent.textContent=Math.max(0,members.length-currentSession.presentPhones.length);
  pillSession.innerHTML=currentSession.active
    ? `<span class='text-dark bg-warning badge'><i class='bi bi-broadcast-pin'></i> Active: ${currentSession.date} ${currentSession.time}</span>`
    : `<span class='badge bg-secondary'>No Active Session</span>`;
}
function filteredMembers(){ const q=(search.value||'').toLowerCase(); const role=roleFilter.value;
  return members.filter(m=>{ const hitQ=!q||`${m.fullName} ${m.phone} ${m.role}`.toLowerCase().includes(q); const hitRole=!role||m.role===role; return hitQ&&hitRole; });
}
function isPresent(phone){ return currentSession.presentPhones.includes(phone); }
function formatPhoneForWhatsApp(phone){ let num=phone.replace(/[^0-9]/g,''); if(num.startsWith('0')) num='233'+num.slice(1); else if(num.startsWith('233')) num=num; else if(num.startsWith('+233')) num=num.slice(1); else num='233'+num; return num; }

// ======= Render Members =======
function renderMembers(){
  listMembers.innerHTML='';
  const list=filteredMembers();
  if(!list.length){ listMembers.innerHTML='<li class="list-group-item">No members available.</li>'; return; }
  list.forEach(m=>{
    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2';
    const present=isPresent(m.phone);
    li.innerHTML=`
      <span class="d-flex align-items-center gap-2 flex-wrap">
        <strong>${m.fullName}</strong>
        <span class="badge bg-dark-subtle text-dark badge-role">${m.role}</span>
        <span class="text-muted"><i class="bi bi-telephone-fill"></i> ${m.phone}</span>
        <span class="badge ${present?'bg-success':'bg-secondary'} present-pill">${present?'Present':'Absent'}</span>
      </span>
      <div class="d-flex gap-1 flex-wrap">
        <button class="btn btn-sm ${present?'btn-outline-success':'btn-success'} btn-toggle" data-phone="${m.phone}">
          <i class="bi bi-check2-square"></i> ${present?'Mark Absent':'Mark Present'}
        </button>
        <a class="btn btn-sm btn-outline-primary" href="tel:${m.phone}"><i class="bi bi-telephone"></i></a>
        <a class="btn btn-sm btn-outline-success" target="_blank" href="https://wa.me/${formatPhoneForWhatsApp(m.phone)}?text=${encodeURIComponent('We missed you at church today!')}" title="WhatsApp Message"><i class="bi bi-whatsapp"></i></a>
      </div>
    `;
    listMembers.appendChild(li);
  });
  document.querySelectorAll('.btn-toggle').forEach(btn=>{
    btn.addEventListener('click',()=>{ const phone=btn.dataset.phone;
      if(isPresent(phone)) currentSession.presentPhones=currentSession.presentPhones.filter(p=>p!==phone);
      else currentSession.presentPhones.push(phone);
      saveSession(); updateStats(); renderMembers();
    });
  });
}

// ======= Calendar =======
let calDate=new Date();
function renderCalendar(){
  calendar.innerHTML='';
  const y=calDate.getFullYear(), m=calDate.getMonth();
  const firstDay=new Date(y,m,1).getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  labelMonth.textContent=calDate.toLocaleString('default',{month:'long',year:'numeric'});

  for(let i=0;i<firstDay;i++){ const div=document.createElement('div'); div.className='day'; calendar.appendChild(div); }
  for(let d=1;d<=daysInMonth;d++){
    const div=document.createElement('div'); div.className='day';
    const dt=`${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
    div.textContent=d;
    if(attendanceHistory.some(h=>h.date===dt)) div.classList.add('has-record');
    div.addEventListener('click',()=>{
      calendar.querySelectorAll('.day').forEach(day=>day.classList.remove('selected'));
      div.classList.add('selected');
      selDate.textContent=dt;
      renderHistory(dt);
    });
    calendar.appendChild(div);
  }
}
prevMonth.addEventListener('click',()=>{ calDate.setMonth(calDate.getMonth()-1); renderCalendar(); });
nextMonth.addEventListener('click',()=>{ calDate.setMonth(calDate.getMonth()+1); renderCalendar(); });

// ======= History =======
function renderHistory(date){
  listHistory.innerHTML='';
  const record=attendanceHistory.find(h=>h.date===date);
  if(!record){ listHistory.innerHTML='<li class="list-group-item">No record</li>'; return; }
  const showPresent=viewPresent.checked;
  const list=members.filter(m=>showPresent ? record.presentPhones.includes(m.phone) : !record.presentPhones.includes(m.phone));
  list.forEach(m=>{
    const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML=`<span>${m.fullName} <small class="text-muted">${m.phone}</small></span>
      <input type="checkbox" class="form-check-input sel-notify" data-phone="${m.phone}"/>`;
    listHistory.appendChild(li);
  });
}

// ======= Events =======
btnStart.addEventListener('click',()=>{
  if(!inDate.value||!inTime.value){ showToast('Select date & time'); return; }
  currentSession={active:true,date:inDate.value,time:inTime.value,presentPhones:[]};
  saveSession(); updateStats(); renderMembers(); showToast('Session Started');
});
btnClose.addEventListener('click',()=>{
  if(!currentSession.active){ showToast('No active session'); return; }
  // Save to history
  const exists=attendanceHistory.find(h=>h.date===currentSession.date);
  if(exists){ exists.presentPhones=currentSession.presentPhones; }
  else attendanceHistory.push({...currentSession});
  saveHistory();
  currentSession={active:false,date:null,time:null,presentPhones:[]};
  saveSession(); updateStats(); renderMembers(); renderCalendar(); showToast('Session Closed & Saved');
});
btnMark.addEventListener('click',()=>{ const p=inPhone.value.trim(); if(!p){ showToast('Enter phone'); return; } if(!members.some(m=>m.phone===p)){ showToast('Phone not found'); return; } if(!isPresent(p)) currentSession.presentPhones.push(p); saveSession(); updateStats(); renderMembers(); showToast('Marked present'); inPhone.value=''; });
search.addEventListener('input',renderMembers);
roleFilter.addEventListener('change',renderMembers);
viewPresent.addEventListener('change',()=>{ if(selDate.textContent!=='â€”') renderHistory(selDate.textContent); });
viewAbsent.addEventListener('change',()=>{ if(selDate.textContent!=='â€”') renderHistory(selDate.textContent); });
btnNotifySelDate.addEventListener('click',()=>{
  const checkboxes=document.querySelectorAll('.sel-notify:checked');
  if(!checkboxes.length){ showToast('Select members'); return; }
  checkboxes.forEach(cb=>{
    const m=members.find(x=>x.phone===cb.dataset.phone);
    if(m) window.open(`https://wa.me/${formatPhoneForWhatsApp(m.phone)}?text=${encodeURIComponent('We missed you at church today!')}`, '_blank');
  });
  showToast('Notification triggered');
});

// ======= Init =======
nowDefaults(); updateStats(); renderMembers(); renderCalendar();
document.getElementById('year').textContent=new Date().getFullYear();
</script>
</body>
</html>
